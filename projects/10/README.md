## Как устроен PostgreSQL.

### Материалы
- [trigger.sql](https://gist.github.com/atlance/b602388c196808c05f3518263e6c13b2)
- [partitions.sql](https://gist.github.com/atlance/50e088b987b0ce45a66b9b291950ea63)
- [Explain PostgreSQL](https://explain.tensor.ru/)
- [New explain | explain.depesz.com](https://explain.depesz.com/)
- [Index Maintenance](https://wiki.postgresql.org/wiki/Index_Maintenance)
- [random_string.sql](https://gist.github.com/atlance/2eceb8f3ac851092ab79f8b2938fe157)

#### Описание/Пошаговая инструкция выполнения задания:
Подготовить список из 6 основных запросов к БД, разработанной на предыдущих занятиях.

- Выбор всех фильмов на сегодня;
- Подсчёт проданных билетов за неделю;
- Формирование афиши (фильмы, которые показывают сегодня);
- Поиск 3 самых прибыльных фильмов за неделю;
- Сформировать схему зала и показать на ней свободные и занятые места на конкретный сеанс;
- Вывести диапазон минимальной и максимальной цены за билет на конкретный сеанс.  
  Целесообразно выбрать 3 "простых" (задействована 1 таблица), 3 "сложных" (агрегатные функции, связи таблиц).  
  Далее нужно заполнить таблицы, увеличив общее количество строк текстовых данных до **10 000**.  
  Затем проведите анализ производительности запросов к БД, сохранить планы выполнения.  
  Заполните таблицы, увеличив общее количество строк текстовых данных до **10 000 000**.  
  Затем проведите анализ производительности запросов к БД, сохранить планы выполнения.  
  На основе анализа запросов и планов предложить оптимизации (индексы, структура, параметры и др.  
  Добавьте индексы и сравните результат, приложив планы выполнения.

#### Критерии оценки:
- скрипт создания БД (с предыдущих занятий);
- скрипт заполнения БД тестовыми данными;
- таблица с результатами по каждому из 6 запросов;
- запрос;
- план на БД до **10 000** строк;
- план на БД до **10 000 000** строк;
- план на БД до **10 000 000** строк, что удалось улучшить;
- перечень оптимизаций с пояснениями;
- отсортированный список (15 значений) самых больших по размеру объектов БД (таблицы, включая индексы, сами индексы);
- отсортированные списки (по 5 значений) самых часто и редко используемых индексов.

#### Результат:
- Запросы:
```sql
-- 1. Выбор всех фильмов на сегодня во всех кинозалах; -----------------------------------------------------------------
SELECT * FROM today_movies;
-- 2. Подсчёт проданных билетов за неделю; -----------------------------------------------------------------------------
SELECT * FROM sold_week_tickets_count;
-- 3. Формирование афиши (фильмы, которые показывают сегодня); <- это реализация 1 пункта. -----------------------------
-- SELECT * FROM today_movies;
-- 4. Поиск 3 самых прибыльных фильмов за неделю; ----------------------------------------------------------------------
SELECT * FROM profitable_movie_of_week LIMIT 3;
-- 5. Сформировать схему зала и показать на ней свободные и занятые места на конкретный сеанс; -------------------------
SELECT s.id, s.places FROM sessions AS s ORDER BY random() LIMIT 1;
-- 6. Вывести диапазон минимальной и максимальной цены за билет на конкретный сеанс. -----------------------------------
SELECT s.id, s.min_ticket_price, s.max_ticket_price FROM sessions AS s ORDER BY random() LIMIT 1;
------------------------------------------------------------------------------------------------------------------------
```

- Анализ:

<i>Замер при `10 125 000` записей в таблице билетов.</i>

<table>
    <thead>
        <tr>
            <th colspan="1"></th>
            <th style="border: 0px 1px 1px 0px" colspan="6">№ Запроса \ Время выполнения в мс.</th>
        </tr>
        <tr>
            <th align="left">Прогресс</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Исходное состояние</td>
            <td>0.796</td>
            <td>1264.481</td>
            <td>-</td>
            <td>2834.827</td>
            <td>629.544</td>
            <td>1372.753</td>
        </tr>
        <tr>
            <td>Добавил индексы на <code>FK</code></td>
            <td>0.809</td>
            <td>1187.696</td>
            <td>-</td>
            <td>2808.042</td>
            <td><b>4.271</b></td>
            <td><b>1.840</b></td>
        </tr>
        <tr>
            <td>В таблице сеансов: <br>разбил колонку <code>start_at timestamp</code><br> на 2 - <code>date</code> и 
<code>time</code>,
<br> дабы не 
делать 
вычисления 
на лету.</td>
            <td>0.660</td>
            <td>1255.476</td>
            <td>-</td>
            <td><b>2395.559</b></td>
            <td>4.695</td>
            <td>1.922</td>
        </tr>
        <tr>
            <td>Добавил индекс на колонки выше</td>
            <td><b>0.248</b></td>
            <td>1239.064</td>
            <td>-</td>
            <td>2386.904</td>
            <td>4.646</td>
            <td>1.915</td>
        </tr>
        <tr>
            <td>Добавил индекс на дату оплаты билета</td>
            <td>0.266</td>
            <td><b>398.446</b></td>
            <td>-</td>
            <td>2363.026</td>
            <td>4.380</td>
            <td>1.943</td>
        </tr>
        <tr>
            <td>Переработал 4-й запрос</td>
            <td>0.243</td>
            <td>392.310</td>
            <td>-</td>
            <td><b>302.749</b></td>
            <td>4.456</td>
            <td>1.945</td>
        </tr>
    </tbody>
</table>

### Материалы
- [Презентация.pdf](./presentation.pdf)
- [trigger.sql](https://gist.github.com/atlance/b602388c196808c05f3518263e6c13b2)
- [partitions.sql](https://gist.github.com/atlance/50e088b987b0ce45a66b9b291950ea63)
- [Explain PostgreSQL](https://explain.tensor.ru/)
- [New explain | explain.depesz.com](https://explain.depesz.com/)
- [Index Maintenance](https://wiki.postgresql.org/wiki/Index_Maintenance)
- [random_string.sql](https://gist.github.com/atlance/2eceb8f3ac851092ab79f8b2938fe157)
